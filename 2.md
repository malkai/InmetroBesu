# necessario instalar todas as bibliotecas utilizados pelo kurbenete em seu sistema operacional

minikube start --memory 16384 --cpus 6 --cni auto

minikube addons enable storage-provisioner

minikube addons enable ingress

minikube dashboard &


# se voce deseja monirtorar a rede retirar o comentario 
# helm install elasticsearch --version 8.5.1  elastic/elasticsearch --namespace quorum --create-namespace --values ./values/elasticsearch.yml --set replicas=1 --set minimumMasterNodes=1 

# helm install kibana --version 8.5.1 elastic/kibana --namespace quorum --values ./values/kibana.yml

# helm install filebeat --version 8.5.1 elastic/filebeat  --namespace quorum --values ./values/filebeat.yml

# kubectl expose deployment kibana-kibana --name="kibana-expose" --type=NodePort --port=5601 -n quorum

# minikube service kibana-expose -n quorum

# criar um indexidor com o comando abaixo

# filebeat-*

# acessar caso seja necessario verificar o cluster
# minikube service kibana-expose -n quorum

# utilizado para moniturar a rede
helm install monitoring prometheus-community/kube-prometheus-stack --version 34.10.0 --namespace quorum --create-namespace --values ./values/monitoring.yml --wait

# Aplicar os valores
kubectl --namespace quorum apply -f  ./values/monitoring/

helm install quorum-monitoring-ingress ingress-nginx/ingress-nginx     --namespace quorum     --set controller.ingressClassResource.name="monitoring-nginx"     --set controller.ingressClassResource.controllerValue="k8s.io/monitoring-ingress-nginx"     --set controller.replicaCount=1     --set controller.nodeSelector."kubernetes\.io/os"=linux     --set defaultBackend.nodeSelector."kubernetes\.io/os"=linux     --set controller.admissionWebhooks.patch.nodeSelector."kubernetes\.io/os"=linux     --set controller.service.externalTrafficPolicy=Local     --set controller.config.allow-snippet-annotations="true"     --set controller.config.annotations-risk-level="Critical"


# Explorador de blocos
helm install blockscout ./charts/blockscout --namespace quorum --create-namespace --values ./values/blockscout-besu.yml

# Explorador de blocos
helm install blockscout ./charts/blockscout --namespace quorum --create-namespace --values ./values/blockscout-besu.yml
helm install quorum-explorer ./charts/explorer --namespace quorum --create-namespace  --values ./values/explorer-besu.yaml
helm install genesis ./charts/besu-genesis --namespace quorum --create-namespace --values ./values/genesis-besu.yml
helm install bootnode-1 ./charts/besu-node --namespace quorum --values ./values/bootnode.yml

# Instalar o genesis
helm install genesis ./charts/besu-genesis --namespace quorum --create-namespace --values ./values/genesis-besu.yml

# bootnodes - optional but recommended
helm install bootnode-1 ./charts/besu-node --namespace quorum --values ./values/bootnode.yml
helm install bootnode-2 ./charts/besu-node --namespace quorum --values ./values/bootnode.yml

# !! IMPORTANT !! - If you use bootnodes, please set `quorumFlags.usesBootnodes: true` in the override yaml files
# for validator.yml, txnode.yml, reader.yml
# All 4 validators must be started for the blocks to be produced.
helm install bootnode-2 ./charts/besu-node --namespace quorum --values ./values/bootnode.yml
helm install validator-1 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm install validator-2 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm install validator-3 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm install validator-4 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm install member-1 ./charts/besu-node --namespace quorum --values ./values/txnode.yml
helm install rpc-1 ./charts/besu-node --namespace quorum --values ./values/reader.yml

# spin up a besu and tessera node pair
helm install member-1 ./charts/besu-node --namespace quorum --values ./values/txnode.yml
helm install rpc-1 ./charts/besu-node --namespace quorum --values ./values/reader.yml

# spin up a quorum rpc node
helm install rpc-1 ./charts/besu-node --namespace quorum --values ./values/reader.yml

# expõe caso seja necessario utilizar 
kubectl expose deployment monitoring-grafana --name="grafana-expose" --type=NodePort --port=3000 -n quorum

# expõe caso seja necessario utilizar 
kubectl expose deployment monitoring-kube-state-metrics --name="monitoring-kube-state-metrics-expose" --type=NodePort --port=8080 -n quorum

# Porta de acesso a rede
kubectl expose service besu-node-rpc-1 --name="rpc-expose" --type=NodePort --port=8545 -n quorum

# Acesso ao grafana
minikube service grafana-expose -n quorum


# minikube service monitoring-kube-prometheus-ope-expose  -n quorum

# minikube service monitoring-kube-state-metrics-expose  -n quorum


# utilizado para deleter um serviço
# kubectl delete service #names -n quorum

# pega status e info dos serviços em deployment
kubectl get deployment -n quorum

# pega status e info dos serviços em service
kubectl get service -n quorum

minikube service quorum-explorer -n quorum

kubectl expose service  besu-node-rpc-1  --name="rpc-expose" --type=NodePort --port=8545 -n quorum

kubectl expose service  besu-node-rpc-2  --name="rpcws-expose" --type=NodePort --port=8546 -n quorum

minikube service rpc-expose -n quorum


kubectl port-forward service/quorum-explorer 9515:80  -n quorum & \
kubectl port-forward service/besu-node-rpc-1 8545:8545  -n quorum & \
kubectl port-forward service/besu-node-rpc-1 8546:8546  -n quorum & 

kubectl port-forward service/besu-node-member-1 9515:80  -n quorum

helm uninstall genesis --namespace quorum 
helm uninstall bootnode-1 --namespace quorum 
helm uninstall bootnode-2 --namespace quorum 
helm uninstall validator-1  --namespace quorum
helm uninstall validator-2  --namespace quorum 
helm uninstall validator-3  --namespace quorum 
helm uninstall validator-4  --namespace quorum 
helm uninstall member-1 --namespace quorum 
helm uninstall rpc-1 --namespace quorum 

helm upgrade validator-1 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm upgrade validator-2 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm upgrade validator-3 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm upgrade validator-4 ./charts/besu-node --namespace quorum --values ./values/validator.yml
helm upgrade member-1 ./charts/besu-node --namespace quorum --values ./values/txnode.yml
helm upgrade rpc-1 ./charts/besu-node --namespace quorum --values ./values/reader.yml